<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>ãƒã‚ºãƒŸ2Dã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¥ãƒ¼</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #88d;
        }

        canvas {
            display: block;
            background: #cce;
        }
    </style>
</head>

<body>
    <canvas id="gameCanvas"></canvas>
    <script src="mouse-engine.js"></script>
    <script>
        // ãƒã‚ºãƒŸã‚¨ãƒ³ã‚¸ãƒ³ã®ä¸€éƒ¨ã«è¿½åŠ ãƒãƒ¥ãƒ¼
        Mouse.drawText = function (text, x, y, options = {}) {
            this.ctx.save();

            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®åæ˜ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é»’æ–‡å­—ãƒ»16pxï¼‰
            this.ctx.font = options.font || "16px sans-serif";
            this.ctx.fillStyle = options.color || "#000";
            this.ctx.textAlign = options.align || "left";
            this.ctx.textBaseline = options.baseline || "top";

            // ã‚«ãƒ¡ãƒ©è¿½å¾“ã™ã‚‹ã‹
            if (options.camera !== false) {
                x -= this.cameraX;
                y -= this.cameraY;
            }

            this.ctx.fillText(text, x, y);

            this.ctx.restore();
        };

        // ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚µã‚¤ã‚ºã‚’æŒ‡å®šï¼ˆä¾‹: æ¨ª4000px, ç¸¦600pxï¼‰
        Mouse.init("gameCanvas", window.innerWidth, window.innerHeight, 4000, 600);
        Mouse.setupUIEvents();

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆãƒãƒ¥ãƒ¼
        Mouse.loadImage("player", "https://mouse-img.netlify.app/imgs/mouse-one.webp")
        Mouse.loadImage("cheese", "https://mouse-img.netlify.app/imgs/cheese.webp")
        const player = Mouse.createRigidBody(100, 100, 40, 40, 0, 0, "player", false, false);
        player.color = "#f55";
        player.collisionType = "rect"; // "rect" ã¾ãŸã¯ "polygon" ã«åˆ‡ã‚Šæ›¿ãˆ
        Mouse.followCamera(player);

        // åºŠä½œæˆãƒãƒ¥ãƒ¼
        for (let i = 0; i < 20; i++) {
            Mouse.createRigidBody(i * 200, 500, 200, 50, 0, 0, null, false, true);
        }
        const floor2 = Mouse.createRigidBody(200, 450, 200, 50, 0, 0, null, false, true);
        const floor3 = Mouse.createRigidBody(400, 350, 200, 50, 0, 0, null, false, true);

        // --- ã“ã“ã§å‚åºŠã‚’è¿½åŠ  ---
        Mouse.createSlope(700, 450, 200, 50, 1, "#888"); // å³ä¸ŠãŒã‚Šå‚
        Mouse.createSlope(950, 450, 200, 50, -1, "#888"); // å·¦ä¸ŠãŒã‚Šå‚

        for (i = 0; i < 1; i++) {
            Mouse.createRigidBody(100, 80, 40, 40, 0, 0, "cheese", false, false, {
                enableAnglePhysics: true,
                angle: 0,
                angularVelocity: 0.1,
                collisionType: "circle",
                radius: 20 // åŠå¾„
            });
        }



        // ä»®æƒ³ãƒ‘ãƒƒãƒ‰ãƒœã‚¿ãƒ³ãƒãƒ¥ãƒ¼
        const leftBtn = {
            x: 50, y: 0, width: 60, height: 60, // yã¯å¾Œã§æ¯ãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°
            holdMode: true,
            pressed: false,
            draw(ctx) {
                ctx.fillStyle = this.pressed ? "#888" : "#444";
                ctx.beginPath();
                ctx.arc(this.x + 30, this.y + 30, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = "#fff";
                ctx.font = "30px sans-serif";
                ctx.fillText("â†", this.x + 15, this.y + 40);
            },
            onClick() {
                if (this.holdMode) {
                    this.pressed = true;
                    movingLeft = true;
                } else {
                    movingLeft = true;
                    setTimeout(() => { movingLeft = false; }, 100);
                }
            },
            onRelease() {
                if (this.holdMode) {
                    this.pressed = false;
                    movingLeft = false;
                }
            }
        };

        const rightBtn = {
            x: 140, y: 0, width: 60, height: 60, // yã¯å¾Œã§æ¯ãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°
            holdMode: true,
            pressed: false,
            draw(ctx) {
                ctx.fillStyle = this.pressed ? "#888" : "#444";
                ctx.beginPath();
                ctx.arc(this.x + 30, this.y + 30, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = "#fff";
                ctx.font = "30px sans-serif";
                ctx.fillText("â†’", this.x + 15, this.y + 40);
            },
            onClick() {
                if (this.holdMode) {
                    this.pressed = true;
                    movingRight = true;
                } else {
                    movingRight = true;
                    setTimeout(() => { movingRight = false; }, 100);
                }
            },
            onRelease() {
                if (this.holdMode) {
                    this.pressed = false;
                }
            }
        };

        const jumpBtn = {
            x: 0, y: 0, width: 60, height: 60, // x,yã¯å¾Œã§æ¯ãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°
            holdMode: false,
            pressed: false,
            draw(ctx) {
                ctx.fillStyle = this.pressed ? "#888" : "#444";
                ctx.beginPath();
                ctx.arc(this.x + 30, this.y + 30, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = "#fff";
                ctx.font = "20px sans-serif";
                ctx.fillText("Jump", this.x + 5, this.y + 40);
            },
            onClick() {
                if (this.holdMode) {
                    this.pressed = true;
                }
                if (player.onGround) {
                    player.vy = -12;
                }
            },
            onRelease() {
                if (this.holdMode) {
                    this.pressed = false;
                }
            }
        };

        Mouse.addUIElement(leftBtn);
        Mouse.addUIElement(rightBtn);
        Mouse.addUIElement(jumpBtn);

        // --- ç·¨é›†ãƒ„ãƒ¼ãƒ«UI ---
        let editMode = false;
        let vertexEditMode = false;
        let selectedBody = player; // é¸æŠä¸­ã®ãƒœãƒ‡ã‚£

        // ãƒœãƒ‡ã‚£é¸æŠç”¨: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã«ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
        Mouse.canvas.addEventListener('mousedown', function (e) {
            if (!editMode) return;
            const rect = Mouse.canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left + Mouse.cameraX;
            const my = e.clientY - rect.top + Mouse.cameraY;
            for (let body of Mouse.rigidBodies) {
                if (
                    mx >= body.x && mx <= body.x + body.width &&
                    my >= body.y && my <= body.y + body.height
                ) {
                    selectedBody = body;
                    break;
                }
            }
        });

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³
        const editBtn = {
            x: 10, y: 10, width: 120, height: 36,
            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = 0.8;
                ctx.fillStyle = editMode ? "#f90" : "#444";
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.globalAlpha = 1;
                ctx.fillStyle = "#fff";
                ctx.font = "18px sans-serif";
                ctx.fillText(editMode ? "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:ON" : "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:OFF", this.x + 8, this.y + 24);
                ctx.restore();
            },
            onClick() {
                editMode = !editMode;
                Mouse.debugMode = editMode;
                if (editMode && vertexEditMode) {
                    Mouse.setupVertexEditing();
                }
            }
        };

        // å½“ãŸã‚Šåˆ¤å®šæ–¹å¼åˆ‡æ›¿ãƒœã‚¿ãƒ³
        const collisionBtn = {
            x: 140, y: 10, width: 120, height: 36,
            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = 0.8;
                ctx.fillStyle = "#444";
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.globalAlpha = 1;
                ctx.fillStyle = "#fff";
                ctx.font = "16px sans-serif";
                ctx.fillText(
                    "åˆ¤å®š:" + (selectedBody.collisionType === "rect" ? "çŸ©å½¢" : "å¤šè§’å½¢"),
                    this.x + 16, this.y + 24
                );
                ctx.restore();
            },
            onClick() {
                if (selectedBody.collisionType === "rect") {
                    selectedBody.collisionType = "polygon";
                    // é ‚ç‚¹ãŒãªã‘ã‚Œã°çŸ©å½¢ã®4é ‚ç‚¹ã‚’ã‚»ãƒƒãƒˆ
                    if (!selectedBody.vertices || selectedBody.vertices.length < 3) {
                        selectedBody.vertices = [
                            { x: 0, y: 0 },
                            { x: selectedBody.width, y: 0 },
                            { x: selectedBody.width, y: selectedBody.height },
                            { x: 0, y: selectedBody.height }
                        ];
                    }
                } else {
                    selectedBody.collisionType = "rect";
                }
            }
        };

        // é ‚ç‚¹ç·¨é›†ON/OFFãƒœã‚¿ãƒ³
        const vertexBtn = {
            x: 270, y: 10, width: 120, height: 36,
            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = 0.8;
                ctx.fillStyle = vertexEditMode ? "#0a8" : "#444";
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.globalAlpha = 1;
                ctx.fillStyle = "#fff";
                ctx.font = "16px sans-serif";
                ctx.fillText(vertexEditMode ? "é ‚ç‚¹ç·¨é›†:ON" : "é ‚ç‚¹ç·¨é›†:OFF", this.x + 10, this.y + 24);
                ctx.restore();
            },
            onClick() {
                vertexEditMode = !vertexEditMode;
                if (vertexEditMode) {
                    Mouse.setupVertexEditing();
                }
            }
        };

        Mouse.addUIElement(editBtn);
        Mouse.addUIElement(collisionBtn);
        Mouse.addUIElement(vertexBtn);

        let movingLeft = false;
        let movingRight = false;

        Mouse.loop(() => {
            // UIãƒœã‚¿ãƒ³ã®åº§æ¨™ã‚’æ¯ãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°
            leftBtn.y = Mouse.height - 120;
            rightBtn.y = Mouse.height - 120;
            jumpBtn.x = Mouse.width - 100;
            jumpBtn.y = Mouse.height - 120;

            // ãƒœã‚¿ãƒ³ã®holdModeãŒtrueã®ã‚‚ã®ã¯æŠ¼ã•ã‚Œã¦ã„ã‚‹é–“ã ã‘movingLeft/movingRightã‚’ç¶­æŒ
            if (leftBtn.holdMode && !leftBtn.pressed) movingLeft = false;
            if (rightBtn.holdMode && !rightBtn.pressed) movingRight = false;

            // å…¥åŠ›å‡¦ç†ãƒãƒ¥ãƒ¼
            if (Mouse.isKeyPressed("ArrowLeft") || movingLeft) {
                player.vx = -5;
                player.flipX = false; // å³å‘ã
            } else if (Mouse.isKeyPressed("ArrowRight") || movingRight) {
                player.vx = 5;
                player.flipX = true; // å·¦å‘ã
            } else {
                player.vx = 0;
            }

            if ((Mouse.isKeyPressed(" ") || Mouse.isKeyPressed("ArrowUp")) && player.onGround) {
                player.vy = -12;
            }

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºON
            Mouse.debugMode = editMode;

            // æç”»ãƒãƒ¥ãƒ¼
            Mouse.clear();
            for (let body of Mouse.rigidBodies) {
                Mouse.drawRigidBody(body, body.color || "blue");
            }
            Mouse.drawRigidBody(floor2, floor2.color || "gray");

            Mouse.drawText("ãƒã‚ºãƒŸã‚¨ãƒ³ã‚¸ãƒ³Î²ğŸ€ğŸ­ğŸğŸ¹ğŸª¤", 1000, 100, {
                font: "24px sans-serif",
                color: "#000",
                camera: false,  // ã‚«ãƒ¡ãƒ©è¿½å¾“ã—ãªã„ã®ã§å›ºå®šè¡¨ç¤ºã«ãªã‚‹ãƒãƒ¥ãƒ¼
            });
            Mouse.drawUI();

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åº§æ¨™è¡¨ç¤º
            Mouse.ctx.save();
            Mouse.ctx.font = "20px monospace";
            Mouse.ctx.fillStyle = "#222";
            Mouse.ctx.fillText(
                `Player: x=${player.x.toFixed(1)}, y=${player.y.toFixed(1)}`,
                400, 30
            );
            Mouse.ctx.restore();
        });
    </script>
</body>

</html>